<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	
    <title>ПМ Бдилка</title>
	 <link rel="icon" type="image/x-icon" href="./favicon.ico">
    <style>
        body {
            font-family: 'Courier New', Courier, monospace;
            color: #ffffff;
            background: radial-gradient(circle at center, #000428, #004e92 70%, #000428);
            background-attachment: fixed;
            background-size: cover;
            margin: 0;
            min-height: 100vh;
            overflow-y: auto;
            display: block;
            padding: 20px;
        }

a {
text-decoration: none;
color:#005f8f;
}

        .container {
            text-align: center;
            max-width: 600px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            box-shadow: 0 0 20px #00d4ff, 0 0 30px #005f8f;
            margin: 20px auto;
            /* Центрируем с помощью отступов */
        }

        /* Заголовок */
        h1 {
            font-size: 3rem;
            color: #00d4ff;
            text-shadow: 0 0 10px #00d4ff, 0 0 20px #00e5ff, 0 0 30px #00aaff;
            margin-bottom: 40px;
        }

        /* Стили для меток и полей */
        label {
            font-size: 1.2rem;
            display: block;
            margin-bottom: 10px;
            color: #a8d0e6;
        }

        input,
        select {
            font-size: 1rem;
            color: #00d4ff;
            background-color: #1e3b5a;
            border: 2px solid #00d4ff;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 20px;
            width: 100%;
            /* Элемент займет всю доступную ширину */
            max-width: 600px;
            /* Максимальная ширина */
            box-shadow: 0 0 5px #00d4ff;
            box-sizing: border-box;
            /* Гарантируем, что padding и border не выталкивают элемент */
        }

        /* Кнопка */
        button {
            font-size: 1.2rem;
            background: linear-gradient(45deg, #00d4ff, #007bbf);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 15px 25px;
            cursor: pointer;
            box-shadow: 0 0 15px #00d4ff;
            transition: all 0.3s ease-in-out;
            margin-top: 20px;
        }

        button:hover {
            background: linear-gradient(45deg, #00eaff, #005f8f);
            box-shadow: 0 0 25px #00eaff, 0 0 35px #00bfff;
            transform: scale(1.05);
        }

        /* Результаты */
        #result {
            font-size: 1.4rem;
            color: #fff;
            background-color: rgba(0, 0, 0, 0.5);
            border: 2px solid #00d4ff;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 0 10px #00d4ff, 0 0 20px #005f8f;
        }

        /* Анимация звезд */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('https://www.transparenttextures.com/patterns/stardust.png');
            z-index: -1;
            opacity: 0.3;
        }

        /* Добавляем плавность взаимодействия */
        input,
        select {
            transition: all 0.3s ease-in-out;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #00eaff;
            box-shadow: 0 0 10px #00eaff, 0 0 15px #005f8f;
        }
		
		
		
		

        table {
            border-collapse: collapse;
            position: relative;
            box-shadow: 0 0 15px #45a29e;
            margin: 0 auto; /* Центрирование таблицы */
        }

        td {
            width: 60px;
            height: 60px;
            text-align: center;
            vertical-align: middle;
            border: 1px solid #1f2833;
            font-size: 18px;
            font-weight: bold;
            color: #c5c6c7;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .highlight {
            background-color: #45a29e;
            color: #0b0c10;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(11, 12, 16, 0.9);
            padding-bottom: 60px;
            transition: opacity 0.5s ease;
        }

        .modal-content {
            background-color: #1f2833;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #66fcf1;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 4px 8px rgba(69, 162, 158, 0.2);
            transition: transform 0.5s ease-in-out;
        }

        .modal-header {
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
            color: #66fcf1;
        }

        .close {
            color: #c5c6c7;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: #66fcf1;
            text-decoration: none;
            cursor: pointer;
        }

        .open-modal-btn {
            background-color: #45a29e;
            color: #0b0c10;
            border: none;
			width:100%;
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .open-modal-btn:hover {
            background-color: #66fcf1;
        }

        .card-list {
            list-style-type: none;
            padding: 0;
            font-size: 18px;
            color: #c5c6c7;
            max-height: 400px;
            overflow-y: auto;
        }

        .card-list li {
            margin: 5px 0;
        }
		
		
		
		
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            opacity: 0;
            transition: opacity 1s;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            pointer-events: none; /* Не блокирует клики */
        }

        #star {
            position: relative;
        }


        @keyframes flyAround {
            0% {
                transform: translate(-50%, -50%);
            }
            25% {
                transform: translate(50vw, -40vh);
            }
            50% {
                transform: translate(-30vw, 30vh);
            }
            75% {
                transform: translate(40vw, 40vh);
            }
            100% {
                transform: translate(-50%, -50%);
            }
        }

        .animate {
            animation: flyAround 4s linear forwards;
            opacity: 1;
        }
		
    </style>
</head>

<body>
    <div class="container">
	
	
    <div id="overlay"><b>Cпасибо!</b></div>
    
	
        <h1>ПМ [<a title="Показать матрицу" onclick="openModal();return false;" id="star" href="" style="color:#45a29e;">✵</a>] Бдилка</h1>

        <div id="selectForm">

            <label for="gender">Выберите пол:</label>
            <select id="gender">
                <option value="male">Мужской</option>
                <option value="female">Женский</option>
            </select>

            <label for="startCard">Последняя карта:</label>
            <select id="startCard">
                <option value="Т">Т</option>
                <option value="К">К</option>
                <option value="Д">Д</option>
                <option value="В">В</option>
                <option value="10">10</option>
                <option value="9">9</option>
                <option value="8">8</option>
                <option value="7">7</option>
                <option value="6">6</option>
                <option value="5">5</option>
                <option value="4">4</option>
                <option value="3">3</option>
                <option value="2">2</option>
            </select>

            <label for="wish">Желаю чтобы:</label>
            <input type="text" id="wish" placeholder="Введите ваше пожелание">

            <label for="sphere">Выберите сферу влияния:</label>
            <select id="sphere" onchange="updateDirections()">
                <option value="стратегия">Стратегия</option>
                <option value="восхищение">Восхищение</option>
                <option value="вдохновение">Вдохновение</option>
                <option value="прорицание">Прорицание</option>
            </select>

            <label for="direction">Выберите направление влияния:</label>
            <select id="direction">
            </select>

            <label for="needType">Выберите тип необходимости:</label>
            <select id="needType">
                <option value="з-р-п">Нужда</option>
                <option value="п-р-з">Внедрение</option>
            </select>

        </div>

        <div id="result">Пасьянс Медичи помогает в сложных ситуациях, а Бдилка выявляет скрытые желания. Перед вами инструмент настоящей свободы в мире, где ваши границы сознания станут как спасением, так и ловушкой. Все расклады сохраняются, по нажатию на звезду сможете просмотреть историю. Если впервые делаете расклад последней картой ставьте 8. <a href="https://github.com/botogame/botogame/blob/main/freedom/interaction/vigil/README.md">Подробнее</a></div>

        <button id="button" style="width:100%;" onclick="getCard()">Получить расклад</button>


    </div>


    <script>
        // Схема выбора карты
        const cardMatrix = {
            'стратегия': {
                'Расположение': 'Т',
                'Позиционирование': 'К',
                'Маскировка': 'Д',
                'Празднование': '2'
            },
            'восхищение': {
                'Блаженство': 'В',
                'Озарение': '10',
                'Посредственность': '9',
            },
            'вдохновение': {
                'Рациональность': '8',
                'Чистка': '7',
                'Уединение': '6'
            },
            'прорицание': {
                'Прагматичность': '5',
                'Привязанность': '4',
                'Выгода': '3'
            }
        };

        // Начальная карта
        const table = {
            'Т': {
                'п-р-з': ['В', '8', 'К'],
                'з-р-п': []
            },
            'К': {
                'п-р-з': ['Д', 'В', '8', '5'],
                'з-р-п': ['Т', 'В', '8', '5']
            },
            'Д': {
                'п-р-з': ['2', '9', '6', '4', '10', '7'],
                'з-р-п': ['4', '7', 'К', '10', '9']
            },
            'В': {
                'п-р-з': ['8', 'К'],
                'з-р-п': ['К', '10', '8', '5', 'Т']
            },
            '10': {
                'п-р-з': ['В', '8', '5', 'К', '7', 'Д'],
                'з-р-п': ['К', '8', '5', '7', '4', 'Д', '9']
            },
            '9': {
                'п-р-з': ['Д', '10', '7', '4', '6', '2'],
                'з-р-п': ['Д', '7', '4', '6', '3', '2']
            },
            '8': {
                'п-р-з': ['К', 'В', '10', '7', '5'],
                'з-р-п': ['Т', 'В', 'К', '10', '5']
            },
            '7': {
                'п-р-з': ['5', '10', '4', '9', '6', 'Д'],
                'з-р-п': ['К', '10', '8', '5', '4', 'Д', '9']
            },
            '6': {
                'п-р-з': ['4', '9', '2', '3'],
                'з-р-п': ['7', '4', 'Д', '9', '3', '2']
            },
            '5': {
                'п-р-з': ['В', '8', '10', '7', 'К'],
                'з-р-п': ['8', 'К', '10', '7', '4']
            },
            '4': {
                'п-р-з': ['5', '10', '7', 'Д', '9', '6'],
                'з-р-п': ['7', 'Д', '9', '6', '3']
            },
            '3': {
                'п-р-з': ['4', '9', '6', '2'],
                'з-р-п': ['6', '2']
            },
            '2': {
                'п-р-з': ['9', '6', '3'],
                'з-р-п': ['6', '3', 'Д', '9']
            }
        };


        const enrichmentData = {
            "7": {
                '♥': "осмотрительного",
                '♠': "осмысленного",
                '♣': "познавательного",
                '♦': "энтузиасного"
            },
            "1": {
                '♥': "сюрреалистического",
                '♠': "парадоксального",
                '♣': "невинного",
                '♦': "замечательного"
            },
            "2": {
                '♥': "поощрительного",
                '♠': "рассудительного",
                '♣': "кокетского",
                '♦': "аргументированого"
            },
            "3": {
                '♥': "осторожного",
                '♠': "безжалостного",
                '♣': "устроенного",
                '♦': "занимательного"
            },
            "4": {
                '♥': "подсматривающего",
                '♠': "абсолютного",
                '♣': "результативного",
                '♦': "координированного"
            },
            "5": {
                '♥': "впечатляющего",
                '♠': "отстаивающего",
                '♣': "привлекательного",
                '♦': "одобряющего"
            },
            "6": {
                '♥': "искренного",
                '♠': "предоставленного",
                '♣': "дружелюбного",
                '♦': "внимательного"
            }
        };

        const cardActions = {
            "Т": {
                '♥': "тайника",
                '♠': "бронирования",
                '♣': "комплекта",
                '♦': "подбора"
            },
            "К": {
                '♥': "уверения",
                '♠': "чередования",
                '♣': "удивления",
                '♦': "впечатления"
            },
            "Д": {
                '♥': "оформления",
                '♠': "проложения",
                '♣': "ограничивания",
                '♦': "доведения"
            },
            "В": {
                '♥': "обнадеживания",
                '♠': "словления",
                '♣': "утомления",
                '♦': "обоснования"
            },
            "10": {
                '♥': "изменения",
                '♠': "пропущения",
                '♣': "сведения",
                '♦': "открытия"
            },
            "9": {
                '♥': "обласкания",
                '♠': "принятия",
                '♣': "налаживания",
                '♦': "сконцентрирования"
            },
            "8": {
                '♥': "привлечения",
                '♠': "предоставления",
                '♣': "замятия",
                '♦': "настроения"
            },
            "7": {
                '♥': "устояния",
                '♠': "уравновешивания",
                '♣': "избавления",
                '♦': "обсуждения"
            },
            "6": {
                '♥': "разбирания",
                '♠': "настроения",
                '♣': "дополнения",
                '♦': "обеспечения"
            },
            "5": {
                '♥': "взвешивания",
                '♠': "предсказания",
                '♣': "впитывания",
                '♦': "советования"
            },
            "4": {
                '♥': "передования",
                '♠': "удовлетворения",
                '♣': "сдобривания",
                '♦': "обрадования"
            },
            "3": {
                '♥': "наполнения",
                '♠': "раздавания",
                '♣': "оптимизирования",
                '♦': "намечивания"
            },
            "2": {
                '♥': "разделения",
                '♠': "подытоживания",
                '♣': "наделения",
                '♦': "подведения"
            }
        };

        let days = [
            'Воскресенье',
            'Понедельник',
            'Вторник',
            'Среду',
            'Четверг',
            'Пятницу',
            'Субботу'
        ];
		
		
const oneYearInSeconds = 365 * 24 * 60 * 60; // Количество секунд в 1 году

        // Масти для мужского и женского пола
        const ar_replace_mast_male = {
            '': '',
            'п-р-з': '♦',
            'з-р-п': '♠'
        };
        const ar_replace_mast_female = {
            '': '',
            'п-р-з': '♥',
            'з-р-п': '♣'
        };

        if (getCookie('startCard') != undefined) {

            set_result(getCookie('gender'), getCookie('startCard'), getCookie('endCard'), getCookie('needType'), getCookie('wish'));

        }
		else{
		
		if (getCookie('endCard') != undefined) {
            document.getElementById("startCard").value = getCookie('endCard');
            document.getElementById('result').innerHTML = 'Ваша последняя карта: ' + getCookie('endCard'); // Очистить предыдущий результат
        }

        if (getCookie('gender') != undefined) {
            document.getElementById("gender").value = getCookie('gender');
        }
		
		}

        // Функция для обновления списка направлений в зависимости от выбранной сферы
        function updateDirections() {
            const sphere = document.getElementById('sphere').value;
            const directionSelect = document.getElementById('direction');

            // Очистим текущие элементы в select "direction"
            directionSelect.innerHTML = '';

            // Заполняем новый список направлений на основе выбранной сферы
            for (const direction in cardMatrix[sphere]) {
                const option = document.createElement('option');
                option.value = direction;
                option.textContent = direction;
                directionSelect.appendChild(option);
            }
        }

        

        // Функция для получения карты
        function getCard() {


            if (document.getElementById('button').innerHTML == 'Завершить расклад') {
                document.getElementById("startCard").value = getCookie('endCard');
                document.getElementById('result').innerHTML = 'Ваша последняя карта: ' + getCookie('endCard'); // Очистить предыдущий результат
                document.getElementById('button').innerHTML = 'Получить расклад';
				
                document.cookie = "startCard=; max-age=-1";
				document.cookie = "needType=; max-age=-1";
				document.cookie = "wish=; max-age=-1";

                document.getElementById('selectForm').style.display = 'block';
				
				var checkMatrix = findMatrix();
				
				if(checkMatrix.cellsLeft===0){
				   openModal();
				}

                return;
            }


            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'Загрузка...'; // Очистить предыдущий результат

            resultDiv.scrollIntoView({
                behavior: "smooth", // Плавная прокрутка
                block: "start" // Начало элемента будет у верхнего края окна
            });

            const wish = document.getElementById('wish').value;
            const startCard = document.getElementById('startCard').value;
            const sphere = document.getElementById('sphere').value;
            const direction = document.getElementById('direction').value;
            const needType = document.getElementById('needType').value;
            const gender = document.getElementById('gender').value;

            const endCard = cardMatrix[sphere][direction];



            if (wish === '') {
                resultDiv.innerHTML = 'Введите желание!';
                return;
            }

            if (startCard === endCard) {
                resultDiv.innerHTML = 'Выбранное направление сходно с последней картой, смените!';
                return;
            }

            if (endCard === 'Т' && needType === 'п-р-з') {
                resultDiv.innerHTML = 'Выбранный тип не применим для выбранного направления, так как представляет собой Т буби (черви)!';
                return;
            }


            set_result(gender, startCard, endCard, needType, wish,true);

        }

        function getCookie(name) {
            var matches = document.cookie.match(new RegExp("(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"));
			
			if(matches){
			   var result = decodeURIComponent(matches[1]);
			   
			   if(result==='undefined'){
			     return undefined;
			   }
			   else if(result===''){
			     return undefined;
			   }
			   else{
			     return result;
			   }
			}
			else{
			  return undefined;
			}
			
        }

function formatDate() {
var date = new Date();

  var dd = date.getDate();
  if (dd < 10) dd = '0' + dd;

  var mm = date.getMonth() + 1;
  if (mm < 10) mm = '0' + mm;

  var yy = date.getFullYear() % 100;
  if (yy < 10) yy = '0' + yy;

  return dd + '/' + mm + '/' + yy;
}

        function set_result(gender, startCard, endCard, needType, wish,generation = false) {

            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'Формирование результата...'; // Очистить предыдущий результат

            // Определяем масть карты на основе выбранного пола и направления

            if (gender === 'male') {
                currentMast = ar_replace_mast_male;
            } else if (gender === 'female') {
                currentMast = ar_replace_mast_female;
            }

            let output = `Желание: желаю чтобы ${wish}.<br><br>Расклад: `;
            let output2 = '';

            const result2 = findBalancedPathWithSpecificEndTransition(startCard, endCard, needType);

            if (result2) {
                result2.path.forEach((card, i) => {

                    let mastNow = currentMast[result2.transitions[i]];

                    let cardWithMast = card + mastNow;
                    output += cardWithMast;
                    if (i < result2.path.length - 1) {
                        output += ` → `;
                    }


                    if (mastNow != '') {

                        output2 += card + mastNow + ': я желаю от своей бдилки ' + enrichmentData[(new Date().getDay())][mastNow] + ' ' + cardActions[card][mastNow] + ' чтобы ' + wish + '<br><br>';
						
						if(generation==true){
						   saveCardGroupsToCookies(formatDate() + ' | желаю чтобы ' +wish, card+mastNow);
						}

                    }

                });


                if (output2 != '') {
                    output2 = '<hr>МАНТРЫ на ' + days[(new Date().getDay())] + ':<br><br>' + output2 + '<button id="button2" class="open-modal-btn" onclick="updateDayNow()">Обновить день недели</button>';
                }

                document.cookie = "startCard=" + startCard + ";expires=" + oneYearInSeconds;
                document.cookie = "endCard=" + endCard + ";expires=" + oneYearInSeconds;
                document.cookie = "needType=" + needType + ";expires=" + oneYearInSeconds;
                document.cookie = "gender=" + gender + ";expires=" + oneYearInSeconds;
                document.cookie = "wish=" + wish + ";expires=" + oneYearInSeconds;

                document.getElementById('button').innerHTML = 'Завершить расклад';
                document.getElementById('selectForm').style.display = 'none';

                document.getElementById("wish").value = '';

            } else {
                output += "не найден.";
            }

            resultDiv.innerHTML = output + output2;

        }


        // Функция для поиска сбалансированного пути
        function findBalancedPathWithSpecificEndTransition(startCard, endCard, lastTransitionType) {


            // Проверка на одинаковые карты
            if (startCard === endCard) {
                return;
            }
            if (endCard === 'Т' && lastTransitionType === 'п-р-з') {
                return;
            }


            let queue = [
                [startCard, [],
                    [], {},
                    0, 0, ''
                ]
            ]; // Начальные параметры
            let cardUsage = {}; // Счетчик использования карт

            while (queue.length > 0) {
                const [currentCard, path, transitions, cardUsage, countPruz, countZrp, lastTransition] = queue.shift();

                // Проверка на максимальное количество использований карты
                if (cardUsage[currentCard] && cardUsage[currentCard] >= 2) {
                    continue;
                }

                // Добавляем текущую карту в путь
                path.push(currentCard);

                // Проверка и обновление переходов
                let newCountPruz = countPruz;
                let newCountZrp = countZrp;
                if (path.length > 1) {
                    if (lastTransition === 'п-р-з') {
                        newCountPruz++;
                    } else if (lastTransition === 'з-р-п') {
                        newCountZrp++;
                    }
                }

                transitions.push(lastTransition);

                // Проверка на совпадение переходов и типов
                if (currentCard === endCard) {
                    if (newCountPruz === newCountZrp && lastTransition === lastTransitionType) {
                        return {
                            path,
                            transitions
                        };
                    }
                }

                cardUsage[currentCard] = (cardUsage[currentCard] || 0) + 1;

                // Переход к следующей карте
                ['п-р-з', 'з-р-п'].forEach(type => {
                    table[currentCard][type].forEach(nextCard => {
                        if (!path.includes(nextCard)) {
                            const newCardUsage = {
                                ...cardUsage
                            };
                            queue.push([nextCard, path.slice(), transitions.slice(), newCardUsage, newCountPruz, newCountZrp, type]);
                        }
                    });
                });
            }

            return null;
        }

        // Инициализация списка направлений при загрузке страницы
        window.onload = updateDirections;
    </script>

    <!-- Модальное окно -->
    <div id="matrixModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div class="modal-header">
                Матрица
            </div>
            <table id="matrix"></table>
			
			
			<button id="button5" class="open-modal-btn" onclick="freeMartix()">Освободить матрицу</button>
			
                <!-- Миниатюрный листинг раскладов -->
                <div id="cardListContainer">
                    <ul id="cardList" class="card-list"></ul>
                </div>
				
				
    <button id="button3" class="open-modal-btn" onclick="deleteCardGroupsCookies()">Очистить историю</button>
        </div>
    </div>
	
	<script>
        // Группировка карт по раскладам
        let cardGroups = getCardGroupsFromCookies();
		
            let currentGroupIndex = 0;
            let currentCardIndex = 0;
            let currentGroupIndexWiew = -2;

       let cardListElement = document.getElementById('cardList');

        // Функция для выбора карт из разных раскладов
        function createCardIterator() {
			
            return function() {
            var groups = Object.values(cardGroups);
            var groupsNames = Object.keys(cardGroups);
			
                if (currentGroupIndex < groups.length) {
                    var currentGroup = groups[currentGroupIndex];
					
			
			if(currentGroupIndexWiew!=currentGroupIndex){
			    currentGroupIndexWiew = currentGroupIndex;
                var currentGroupName = groupsNames[currentGroupIndexWiew];

			    var li = document.createElement('li');
                li.textContent = `${currentGroupName}: ${cardGroups[currentGroupName].join(' → ')}`;
                cardListElement.appendChild(li);
			}

                    if (currentCardIndex < currentGroup.length) {
                        return currentGroup[currentCardIndex++];
                    } else {
                        currentCardIndex = 0;
                        currentGroupIndex++;
                        return createCardIterator(cardGroups)();
                    }
                }
                return null; // Все карты использованы
            };
        }

        const getNextCard = createCardIterator();

        // Функция для заполнения матрицы по спирали
        function fillSpiral(n) {
            const matrix = Array.from({ length: n }, () => Array(n).fill(null));
            let x = Math.floor(n / 2);
            let y = Math.floor(n / 2);
            let num = 1;
            let directions = [[0, 1], [1, 0], [0, -1], [-1, 0]]; // Направления: вправо, вниз, влево, вверх
            let dir = 0;  // Начинаем двигаться вправо
            let steps = 1;

            matrix[x][y] = num++;

            while (num <= n * n) {
                for (let i = 0; i < 2; i++) {
                    for (let step = 0; step < steps; step++) {
                        x += directions[dir][0];
                        y += directions[dir][1];
                        if (x >= 0 && x < n && y >= 0 && y < n) {
                            matrix[x][y] = num++;
                        }
                    }
                    dir = (dir + 1) % 4;  // Поворачиваемся по часовой стрелке
                }
                steps++;  // Увеличиваем шаги после каждого полного круга
            }
            return matrix;
        }

        // Функция для отображения матрицы в таблице
        function renderMatrix(matrix) {
            const table = document.getElementById('matrix');
            const n = matrix.length;
			
			table.innerHTML = '';
            cardListElement.innerHTML = '';
			
            currentGroupIndex = 0;
            currentCardIndex = 0;
            currentGroupIndexWiew = -2;
			
            for (let i = 0; i < n; i++) {
                const tr = document.createElement('tr');
                for (let j = 0; j < n; j++) {
                    const td = document.createElement('td');
                    //td.textContent = getNextCard();
                    tr.appendChild(td);
                }
                table.appendChild(tr);
            }
			
            highlightSequence(matrix);

            // Добавляем выделение последовательности чисел
			if(countAllCards()>0){
			document.getElementById('button3').style.display = "block";
			}
			else{
			cardListElement.innerHTML = '<br><br><b style="float:right;text-align:center;width:100%;">Здесь будет хранится история ваших желаний. Но вы сможете её очистить. Или подождать когда 100% заполнится матрица чтобы её освободить!</b>';
			document.getElementById('button3').style.display = "none";
			}
        }

        // Функция для выделения последовательности чисел от 1 до 25
        function highlightSequence(matrix) {
            const n = matrix.length;
            const positions = [];

            // Собираем позиции для всех чисел от 1 до 25
            for (let i = 0; i < n; i++) {
                for (let j = 0; j < n; j++) {
                    if (matrix[i][j] !== null) {
                        positions[matrix[i][j] - 1] = { x: i, y: j };
                    }
                }
            }

            // Добавляем класс highlight для каждого числа от 1 до 25
            positions.forEach((position, index) => {
                const td = document.getElementById('matrix').rows[position.x].cells[position.y];
				
				
                setTimeout(() => {
				
				if(currentGroupIndexWiew==-2){
				currentGroupIndexWiew = -1;
				var cardNext = '✵';
				}
				else{
				var cardNext = getNextCard();
				}
				
				if(cardNext!==null){
                    td.classList.add('highlight');
					td.textContent = cardNext;
				}
                }, index * 50);  // Задержка, чтобы подсветка происходила поочередно
            });
        }
		
		function findMatrix() {
		
		var size = countAllCards() + 1;

		
    const matrices = [3, 5, 7, 9, 11, 13, 15];
    let result = {};

    for (let i = 0; i < matrices.length; i++) {
        let matrixSize = matrices[i] * matrices[i]; // Количество клеток в матрице
        if (size <= matrixSize) {
            result.matrix = matrices[i];
            result.cellsLeft = matrixSize - size;
            break;
        }
    }

    // Если не подошла ни одна матрица
    if (!result.matrix) {
        result.matrix = false;
        result.cellsLeft = false;
    }

    return result;
}

function countAllCards() {
    let totalCards = 0;
    
    // Проходим по каждому раскладу в объекте
    for (let group in cardGroups) {
        totalCards += cardGroups[group].length; // Добавляем количество карт в этом раскладе
    }

    return totalCards;
}

// Функция для сохранения данных в куки
function saveCardGroupsToCookies(groupName, card) {
// Добавляем карту в указанную группу или создаем новую группу, если она не существует
    if (!cardGroups[groupName]) {
        cardGroups[groupName] = [];  // Если группа не существует, создаем её
    }
    cardGroups[groupName].push(card); // Добавляем карту в группу
    // Сериализуем объект в строку
    var serializedData = JSON.stringify(cardGroups);

    // Сохраняем данные в куки с временем действия 1 год

document.cookie = `cardGroups=${encodeURIComponent(serializedData)};max-age=${oneYearInSeconds}`;
}


// Функция для извлечения данных из куки
function getCardGroupsFromCookies() {
    const cookieValue = document.cookie
        .split('; ')
        .find(row => row.startsWith('cardGroups='))
        ?.split('=')[1];

    if (cookieValue) {
        // Десериализуем данные обратно в объект
        return JSON.parse(decodeURIComponent(cookieValue));
    } else {
        return {};
    }
}

// Функция для удаления куки
function deleteCardGroupsCookies() {

var isDelete = confirm("Точно хотите удалить всю историю?");

if(isDelete==true){
   
if(document.getElementById('button').innerHTML == 'Завершить расклад'){
getCard();

}

    document.cookie = "cardGroups=;max-age=-1";
	cardGroups = {};
openModal();}
}

        // Функция для открытия модального окна
        function openModal() {
		
		var checkMatrix = findMatrix();
		
            var matrix = fillSpiral(checkMatrix.matrix);
            renderMatrix(matrix);

			if(getCookie('startCard') === undefined && checkMatrix.cellsLeft===0){
            document.getElementById("cardListContainer").style.display = "none";
            document.getElementById("button3").style.display = "none";
            document.getElementById("button5").style.display = "block";
			}
			else{
			
            document.getElementById("cardListContainer").style.display = "block";
            document.getElementById("button5").style.display = "none";
			
			if(countAllCards()>0){
            document.getElementById("button3").style.display = "block";
			}
			else{
			
            document.getElementById("button3").style.display = "none";
			}
			
			}
			
            document.getElementById("matrixModal").style.display = "block";
        }

        // Функция для закрытия модального окна
        function closeModal() {
            document.getElementById("matrixModal").style.display = "none";
        }
		
		
		function updateDayNow(){
		set_result(getCookie('gender'), getCookie('startCard'), getCookie('endCard'), getCookie('needType'), getCookie('wish'));
		}
		
		function freeMartix(){
		
    document.cookie = "cardGroups=;max-age=-1";
	cardGroups = {};
	
	
	closeModal();
	
	darkenScreenAndAnimateStar();
		
		}
		
		function darkenScreenAndAnimateStar() {
            
			
        var overlay = document.getElementById('overlay');
        var star = document.getElementById('star');
			
            // Затемнение экрана
            overlay.style.opacity = 1;
            overlay.style.pointerEvents = 'auto';
            star.style.position = 'fixed';

            // Появление звезды и запуск анимации
            star.classList.add('animate');
			
            // Возвращаем звезду в исходное положение
            setTimeout(() => {
                star.classList.remove('animate');
            star.style.position = 'relative';
            }, 4000);
            // Возвращаем звезду в исходное положение
            setTimeout(() => {
                overlay.style.opacity = 0;
                overlay.style.pointerEvents = 'none';
                openModal();
            }, 4500);
        }
    </script>
	
	
</body>

</html>
