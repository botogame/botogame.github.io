<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Тетрадь Смерти. Перелом</title>
  <link rel="icon" type="image/x-icon" href="./favicon.png?v=1.0" />
  <style>body {
  font-family: "Courier New", monospace;
  background-color: #111;
  background-image: url("sarum.webp"); /* ← Укажи путь к своей картинке */
  background-size: cover; /* Покрывает весь экран */
  background-position: center;
  background-attachment: fixed; /* Фон не скроллится */
  color: #eee;
  padding: 20px;
  margin: 0;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
}
    h1, h2 {
      color: crimson;
      text-align: center;
      text-shadow: 0 0 5px crimson;
      margin: 0.2em 0;
    }
    form {
      background: #222;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 0 15px crimson;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 20px;
      max-width: 400px;
    }
    label {
      display: flex;
      flex-direction: column;
      font-weight: bold;
      font-size: 0.9rem;
      user-select: none;
    }
    input, select, button {
      padding: 10px;
      background: #111;
      color: #eee;
      border: 1px solid #444;
      border-radius: 6px;
      font-family: monospace;
      font-size: 1rem;
    }
    button {
      background-color: crimson;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: darkred;
    }

    .stats {
      width: 100%;
      max-width: 400px;
      background: #222;
      border-radius: 10px;
      padding: 12px;
      margin-top: 10px;
      color: #0f0;
      font-weight: bold;
      text-align: center;
      box-shadow: 0 0 10px crimson;
      user-select: none;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      font-size: 1.1rem;
    }
    .stats a {
      color: #eee;
      text-decoration: underline;
      cursor: pointer;
      font-weight: normal;
    }
    .stats a:hover {
      color: crimson;
    }

    .output {
      width: 100%;
      max-width: 700px;
      background: #222;
      padding: 15px;
      border-radius: 10px;
      margin-top: 25px;
      box-shadow: 0 0 20px crimson;
      color: #eee;
      user-select: text;
	  padding:12px;
    }
    .output h3 {
      margin-top: 0;
      color: crimson;
      text-align: center;
      text-shadow: 0 0 8px crimson;
    }

    .orders-container {
      display: flex;
      gap: 30px;
      margin-top: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .orders-column {
      flex: 1 1 300px;
      background: #111;
      border: 1px solid crimson;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 0 10px crimson;
      max-height: 300px;
      overflow-y: auto;
    }

    .orders-column h4 {
      margin-top: 0;
      color: crimson;
      text-align: center;
      text-shadow: 0 0 6px red;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .orders-column pre {
      white-space: pre-wrap;
      word-break: break-word;
      color: #eee;
      font-size: 1em;
      margin: 0;
    }

    /* Popup rules styling */
    #rulesPopup {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      display: flex;
      justify-content: center;
      align-items: center;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 1000;
    }
    #rulesPopup.show {
      visibility: visible;
      opacity: 1;
    }
    #rulesContent {
      background: #111;
      color: #eee;
      border: 2px solid crimson;
      border-radius: 12px;
      padding: 20px 30px;
      max-width: 400px;
      font-family: monospace;
      font-size: 1rem;
      text-align: left;
      box-shadow: 0 0 20px crimson;
      position: relative;
    }
    #closeRules {
      background: crimson;
      border: none;
      color: #eee;
      font-weight: bold;
      font-size: 1.2rem;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
    }
    #closeRules:hover {
      background: darkred;
    }
	
	@keyframes electricWords {
  0% {
    background-position: 0% 50%;
    text-shadow: 0 0 4px crimson;
  }
  50% {
    background-position: 100% 50%;
    text-shadow: 0 0 12px white, 0 0 6px crimson;
  }
  100% {
    background-position: 0% 50%;
    text-shadow: 0 0 4px crimson;
  }
}



.title {
  position: relative;
  display: inline-block;
  font-size: 3rem;
  color: crimson;
  font-weight: bold;
}

.title .lightning {
  position: absolute;
  top: -12px; /* немного выше над текстом */
  left: 0;
  width: 100%;
  height: 10px;
  pointer-events: none;
  z-index: 2;
}

.title polyline {
  fill: none;
  stroke: yellow;
  stroke-width: 2;
  stroke-linejoin: round;
  stroke-linecap: round;
  filter: drop-shadow(0 0 2px white);
  transition: all 0.2s ease;
}


 
#dreamOverlay {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.8);
  z-index: 9998; /* ниже, чем у попапа */
  opacity: 0;
  pointer-events: none;
  transition: opacity 1s ease;
  display: block;
}

#dreamOverlay.active {
  opacity: 1;
  pointer-events: auto;
}

#dreamPopup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0, 0, 0, 0.8); /* затемнение */
  color: #40E0D0;
  padding: 20px 30px;
  border-radius: 12px;
  font-size: 2rem;
  font-weight: bold;
  text-align: center;
  box-shadow: 0 0 30px #0f0, 0 0 60px #0f0, 0 0 90px #0f0; /* психоделический свет */
  z-index: 9999;

  opacity: 0;
  pointer-events: none;
  transition: opacity 1s ease;
  display: block; /* чтобы работал transition opacity */
  animation: pulse 1s infinite alternate;
}

#dreamPopup.active {
  opacity: 1;
  pointer-events: auto;
}

@keyframes pulse {
  from {
    transform: translate(-50%, -50%) scale(1);
    box-shadow: 0 0 30px #0f0, 0 0 60px #0f0;
  }
  to {
    transform: translate(-50%, -50%) scale(1.05);
    box-shadow: 0 0 60px #0f0, 0 0 100px #0f0;
  }
}
	
	.orders-column2 {
  white-space: normal;       /* чтобы переносить и не ломать пробелы */
  text-align: center;        /* выравнивание по центру */
  font-family: monospace;    /* фиксированная ширина шрифта */
  margin: 0 auto;
  width: 100%;        /* ширина по содержимому */
  max-width: 100%;           /* не больше контейнера */
}


.RomanMonth{
      width: 100%;
      max-width: 400px;
      background: #222;
      border-radius: 10px;
      padding: 12px;
      margin-top: 10px;
      color: #40E0D0;
      font-weight: bold;
      text-align: center;
      box-shadow: 0 0 10px crimson;
      user-select: none;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      font-size: 1.1rem;}

  </style>
</head>
<body>
  <h2>Тетрадь Смерти</h2>
  <h1 class="title">
  <span>ПЕРЕЛОМ</span>
  <svg class="lightning" viewBox="0 0 100 10" preserveAspectRatio="none">
    <polyline points="" />
  </svg>
</h1>

<script>
function generateZigzagPoints(width = 100, height = 10, segments = 12) {
  const points = [];
  const step = width / segments;

  for (let i = 0; i <= segments; i++) {
    const x = (i * step).toFixed(1);
    const y = (Math.random() * height).toFixed(1);
    points.push(`${x},${y}`);
  }

  return points.join(' ');
}

function updateLightning() {
  const polyline = document.querySelector('.lightning polyline');
  polyline.setAttribute('points', generateZigzagPoints());
}

// Запуск анимации
setInterval(updateLightning, 300);
updateLightning();
</script>

  <div class="stats" id="stats">
    Счет: 0 - 0
    <a href="#" id="rulesLink">Правила</a>
  </div>
  
  <div class="RomanMonth" id="RomanMonth">
    
  </div>

  <form id="deathForm">
    <label>Кто Вы:
      <select id="gender" required>
        <option value="мужской">Мужчина</option>
        <option value="женский">Женщина</option>
      </select>
    </label>

    <label>Союзник:
      <select id="type" required>
        <option value="убрать">Аннигилятор</option>
        <option value="подменить">Создатель</option>
      </select>
    </label>

    <label>Имя Клиента:
      <input type="text" id="name" required />
    </label>

    <label>Пол Клиента:
      <select id="clientGender" required>
        <option value="мужской">Мужчина</option>
        <option value="женский">Женщина</option>
      </select>
    </label>

    <label>Время Клиента:
      <select id="clientTime" required>
        <option value="текущий">Текущее - клиент в вашем времени</option>
        <option value="младший">Прошлое - клиент младший</option>
        <option value="старший">Будующее - клиент старший</option>
      </select>
    </label>

    <label><text id="methodLabel">Кем хотите чтобы Клиент был:</text>
      <input type="text" id="method" required />
    </label>

    <button type="submit">Заказать</button>
	<button id="buttonClose" onclick="Website2APK.exitApp()">Закрыть программу</button>
  </form>

  <div class="output" id="result">
    <h3>Несбалансированные заказы:</h3>
    <div class="orders-container">
      <div class="orders-column" id="orders-remove">
        <h4>Для аннигилятора (убрать)</h4>
        <pre class="orders-column2"></pre>
      </div>
      <div class="orders-column" id="orders-replace">
        <h4>Для создателя (подменить)</h4>
        <pre class="orders-column2"></pre>
      </div>
    </div>
  </div>

  <!-- Popup Правил -->
  <div id="rulesPopup">
    <div id="rulesContent">
      <h3>Правила</h3>
      <ol>
        <li>Заимейте 4-е поношенные вещи гардероба 4-х разных людей для активации Перелома.</li>
        <li>Храните вещи для Перелома отдельно и не носите их никогда.</li>
        <li>В Клиенты можете записывать косвенные именые обозначения, в том числе "половинка того то".</li>
        <li>Мечта оцифровывается в код для принятия сном.</li>
        <li>При создании заказов соблюдайте баланс между союзниками.</li>
        <li>Когда баланс соблюден, заказы принимаются в реализацию.</li>
        <li>Описание про Перелом читайте <a href="https://github.com/botogame/botogame/blob/main/freedom/distribution/fracture/README.md" target="_blank">здесь</a>.</li>
      </ol>
      <button id="closeRules" title="Принимаю">Принимаю</button>
    </div>
  </div>
<!-- Popup для суммы мечты -->
<div id="dreamOverlay"></div>
<div id="dreamPopup"></div>
<script>

function getAncientRomanMonth() {
  const today = new Date();
  const day = today.getDate();
  const month = today.getMonth(); // 0-based (0 = январь)

  // Кол-во дней в каждом месяце обычного (невисокосного) года
  const gregorianMonths = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

  // Вычисляем номер дня в году
  let dayOfYear = 0;
  for (let i = 0; i < month; i++) {
    dayOfYear += gregorianMonths[i];
  }
  dayOfYear += day;

  // Смещаем так, чтобы 1 марта стало днём 1
  const dayFromMarch = (dayOfYear >= 60) ? (dayOfYear - 59) : (dayOfYear + 306); // 59 = 31 (янв) + 28 (фев)

  // Диапазоны месяцев (от 1 марта)
  const ranges = [
    { name: "1-м узле сна: ЗЕРКАЛО ТЕЛА", desc: "Ты внутри сна — но не управляешь. Все движения автоматичны. Всё — как будто не твое.",     number: 1, from: 1,   to: 31 },
    { name: "2-м узле сна: МЕХАНИЗМ ВРЕМЕНИ", desc: "Ты снова в том же месте. Повтор. День сурка. Всё предсказуемо — и бесконечно.",    number: 2, from: 32,  to: 61 },
    { name: "3-м узле сна: ЭМОЦИОНАЛЬНАЯ ГРОЗА",desc: "Напряжение нарастает.",       number: 3, from: 62,  to: 92 },
    { name: "4-м узле сна сна: МИР БЕЗ ЗАКОНОВ", desc: "Абсурд, сломанные законы, но всё — логично по-своему.",     number: 4, from: 93,  to: 122 },
    { name: "5-м узле сна: ЗАПРЕТНАЯ ПАМЯТЬ",desc: "Спертый воздух, пыль в солнечном луче, напряжённая тишина. Всё внутри будто ждало, что ты вернёшься — хотя ты обещал себе, что не вернёшься никогда.",   number: 5, from: 123, to: 153 },
    { name: "6-м узле сна: ПОРОГОВЫЕ ЛИЦА", desc: "Вежливая ловушка. Всё кажется 'правильным': мягкие голоса, разумные аргументы, знакомые лица. Но внутри — нарастающий холод.",   number: 6, from: 154, to: 183 },
    { name: "7-м узле сна: ОБРАТНАЯ СТОРОНА", desc: "Тревожная встреча. Кто-то похож на тебя, но искажён.",  number: 7, from: 184, to: 213 },
    { name: "8-м узле сна: ШЕПОТ ПРЕДКОВ",desc: "Приглушённо, по древнему, сакрально.",     number: 8, from: 214, to: 244 },
    { name: "9-м узле сна: ОБРАЗ ИЗ СНА",  desc: "Символично, почти все мифическое.",  number: 9, from: 245, to: 274 },
    { name: "10-м узле сна: БЕЛАЯ ПУСТОТА", desc: "Белый шум, ничто, спокойствие, почти смерть.",   number: 10,from: 275, to: 305 }
  ];

  // Ищем соответствующий месяц по диапазону
  const found = ranges.find(r => dayFromMarch >= r.from && dayFromMarch <= r.to);

  return found
    ? `Перелом на ${found.name}. ${found.desc}`
    : "Сейчас зимний период, и вы в промежутке. Это фаза, где всё течёт, но ничего не закрепляется. Решения, принятые в промежутке, редко выживают. Перелом не возможен. Но вы можете сделать вызов с помощью психоделиков.";
}

if (typeof Website2APK !== "undefined") {
        document.getElementById("buttonClose").style.display = "block";
    }
    else{
        document.getElementById("buttonClose").style.display = "none";
    }

  const form = document.getElementById("deathForm");
  const genderSelect = document.getElementById("gender");
  const typeSelect = document.getElementById("type");
  const nameInput = document.getElementById("name");
  const methodInput = document.getElementById("method");
  const clientGenderSelect = document.getElementById("clientGender");
  const methodLabel = document.getElementById("methodLabel");
  const clientTimeSelect = document.getElementById("clientTime");

  const statsDiv = document.getElementById("stats");
  const RomanMonthDiv = document.getElementById("RomanMonth");
  const resultDiv = document.getElementById("result");
  const removePre = document.querySelector("#orders-remove pre");
  const replacePre = document.querySelector("#orders-replace pre");

  const rulesLink = document.getElementById("rulesLink");
  const rulesPopup = document.getElementById("rulesPopup");
  const closeRulesBtn = document.getElementById("closeRules");
  
  
  const letterValues = {
    'А': 1, 'Б': 2, 'В': 3, 'Г': 4, 'Д': 5, 'Е': 6, 'Ё': 7,
    'Ж': 8, 'З': 9, 'И': 10, 'Й': 11, 'К': 12, 'Л': 13, 'М': 14,
    'Н': 15, 'О': 16, 'П': 17, 'Р': 18, 'С': 19, 'Т': 20, 'У': 21,
    'Ф': 22, 'Х': 23, 'Ц': 24, 'Ч': 25, 'Ш': 26, 'Щ': 27, 'Ъ': 28,
    'Ы': 29, 'Ь': 30, 'Э': 31, 'Ю': 32, 'Я': 33
  };

const digitWords = {
  0: 'ноль', 1: 'один', 2: 'два', 3: 'три', 4: 'четыре',
  5: 'пять', 6: 'шесть', 7: 'семь', 8: 'восемь', 9: 'девять'
};

function replaceNumbersWithWords(text) {
  return text.replace(/\d+/g, (num) => {
    return num.split('').map(d => digitWords[d]).join(' ');
  });
}

  function calculateDreamValue(text) {
  text = replaceNumbersWithWords(text);

    return text
      .toUpperCase()
      .split('')
      .map(ch => letterValues[ch] || 0)
      .reduce((a, b) => a + b, 0);
  }

function updateRomanMonthDiv() {

RomanMonthDiv.innerHTML = getAncientRomanMonth();
}

updateRomanMonthDiv();


function showDreamPopup(value) {
  const popup = document.getElementById('dreamPopup');
  const overlay = document.getElementById('dreamOverlay');

  popup.textContent = `Код ${value}`;
  popup.classList.add('active');
  overlay.classList.add('active');

  setTimeout(() => {
    popup.classList.remove('active');
    overlay.classList.remove('active');
  }, 5000);
}

  // Обновление подписи поля method в зависимости от пола Клиента
  clientGenderSelect.addEventListener("change", () => {
  updatemethodLabel();
  });
  
  typeSelect.addEventListener("change", () => {
  updatemethodLabel();
  });
  
  genderSelect.addEventListener("change", () => {
  updatemethodLabel();
  });
  clientTimeSelect.addEventListener("change", () => {
  updatemethodLabel();
  });
  function updatemethodLabel() {
   if(genderSelect.value=='мужской'){
   var mechta = 'желаете';
   }
   else{
   var mechta = 'хотите';
   }
   if(typeSelect.value=='убрать'){
   var ne = ' не';
   }
   else{
   var ne = '';
   }
   
   
var clientTime = clientTimeSelect.value;
   
    if (clientGenderSelect.value === "мужской") {
      methodLabel.innerText = "Кем " + mechta+ " чтобы " + clientTime + " Клиент" + ne+ " был:";
    } else {
      methodLabel.innerText = "Кем " + mechta+ " чтобы " + clientTime + " Клиент" + ne+ " стала:";
    }
  }

  function updateStats(entries) {
    let countU = 0;
    let countP = 0;

    entries.forEach(entry => {
      if (entry.startsWith("убрать")) countU++;
      if (entry.startsWith("подменить")) countP++;
    });

    statsDiv.childNodes[0].nodeValue = `Счет: ${countU} - ${countP} `;

    if (countU === countP && countU > 0) {
      localStorage.removeItem("deaths");
      removePre.textContent = "";
      replacePre.textContent = "";
      statsDiv.childNodes[0].nodeValue = "Заказы приняты на реализацию ";
    }
  }

  function renderHistory(entries) {
  const sanitizeEntry = (entry, index) => {
    let value = entry.split("::")[1];

    // Если значение не число, заменяем его на индекс + 1
    if (isNaN(value)) {
	
	 value = calculateDreamValue(value);
    }

    return value;
  };

  const removeEntries = entries
    .filter(entry => entry.startsWith("убрать"))
    .map(sanitizeEntry)
    .join(" "); // через пробел

  const replaceEntries = entries
    .filter(entry => entry.startsWith("подменить"))
    .map(sanitizeEntry)
    .join(" "); // через пробел

  removePre.textContent = removeEntries || "";
  replacePre.textContent = replaceEntries || "";
}

  form.addEventListener("submit", e => {
    e.preventDefault();

    const gender = genderSelect.value;
    const type = typeSelect.value;
    const name = nameInput.value.trim();
    const method = methodInput.value.trim();
    const clientGender = clientGenderSelect.value;

    if (!gender || !type || !name || !method || !clientGender) {
      alert("Пожалуйста, заполните все поля.");
      return;
    }

    const transformedType = gender === "женский"
      ? (type === "убрать" ? "не хорошего" : "прекрасного")
      : (type === "убрать" ? "не лучшего" : "скорости");
	  
    const transformedNe = gender === "женский"
      ? (type === "убрать" ? "не " : "")
      : (type === "убрать" ? "не " : "");
	  
	  
   
   if(clientGenderSelect.value=='женский'){
   if(clientTimeSelect.value=='текущий'){
   var clientTime = 'текушая';
   }
   else if(clientTimeSelect.value=='младший'){
   var clientTime = 'младшая';
   }
   else{
   var clientTime = 'старшая';
   }
   
   }
   else{
   var clientTime = clientTimeSelect.value;
   
   }
   

    const transformedClientGender = clientGender === "мужской" ? "был" : "стала";
    const sentence = `Надо мне ${transformedType} чтобы ${clientTime} ${name} ${transformedNe}${transformedClientGender} ${transformedNe}${method}`;
	
	const dreamValue = calculateDreamValue(sentence);

    let history = JSON.parse(localStorage.getItem("deaths") || "[]");
    history.push(`${type}::${dreamValue}`);
    localStorage.setItem("deaths", JSON.stringify(history));
localStorage.setItem("selectedGender", gender);
localStorage.setItem("selectedType", type);

    renderHistory(history);
    updateStats(history);
	showDreamPopup(dreamValue);
updateRomanMonthDiv();
    form.reset();
    // Чтобы подпись method обновилась сразу на мужской по умолчанию после сброса формы:
    clientGenderSelect.dispatchEvent(new Event("change"));
	
	// Восстанавливаем пол "Кто вы" и союзника
var savedGender = localStorage.getItem("selectedGender");
if (savedGender) genderSelect.value = savedGender;

var savedType = localStorage.getItem("selectedType");
if (savedType) typeSelect.value = savedType;
	
	updatemethodLabel();
  });

  window.addEventListener("load", () => {
    const history = JSON.parse(localStorage.getItem("deaths") || "[]");
    renderHistory(history);
    updateStats(history);
    typeSelect.dispatchEvent(new Event("change"));
    clientGenderSelect.dispatchEvent(new Event("change"));
	// Восстанавливаем пол "Кто вы" и союзника
var savedGender = localStorage.getItem("selectedGender");
if (savedGender) genderSelect.value = savedGender;

var savedType = localStorage.getItem("selectedType");
if (savedType) typeSelect.value = savedType;

updatemethodLabel();
  });

  // Работа с попапом правил
  rulesLink.addEventListener("click", e => {
    e.preventDefault();
    rulesPopup.classList.add("show");
  });

  closeRulesBtn.addEventListener("click", () => {
    rulesPopup.classList.remove("show");
  });

  window.addEventListener("click", (e) => {
    if (e.target === rulesPopup) {
      rulesPopup.classList.remove("show");
    }
  });

  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && rulesPopup.classList.contains("show")) {
      rulesPopup.classList.remove("show");
    }
  });
</script>
</body>
</html>
